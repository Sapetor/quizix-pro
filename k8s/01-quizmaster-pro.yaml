apiVersion: v1
kind: Namespace
metadata:
  name: quizmaster
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: quizmaster-config
  namespace: quizmaster
data:
  NODE_ENV: "production"
  PORT: "3000"
  # Note: BASE_PATH auto-detects to /quizmaster/ when NODE_ENV=production
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: quizmaster-quizzes
  namespace: quizmaster
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: quizmaster-results
  namespace: quizmaster
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 2Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: quizmaster-uploads
  namespace: quizmaster
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: Service
metadata:
  name: quizmaster-pro
  namespace: quizmaster
spec:
  selector:
    app: quizmaster-pro
  # Session affinity is critical for Socket.IO sticky sessions
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours
  ports:
    - name: http
      port: 3000
      targetPort: 3000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: quizmaster-pro
  namespace: quizmaster
spec:
  replicas: 1
  # Use Recreate strategy with RWO volumes to avoid Multi-Attach errors
  strategy:
    type: Recreate
  selector:
    matchLabels: { app: quizmaster-pro }
  template:
    metadata:
      labels: { app: quizmaster-pro }
    spec:
      # Pin to a specific node - eliminates Multi-Attach errors with RWO volumes
      # Run: kubectl get nodes -l kubernetes.io/hostname -o name
      # Pick a worker node with adequate disk space
      nodeSelector:
        kubernetes.io/hostname: k8s-worker-node2

      # Give time for graceful shutdown and volume detachment
      terminationGracePeriodSeconds: 60

      # Uncomment if your Docker Hub repo is private
      # imagePullSecrets:
      #   - name: dockerhub-cred

      # Init container to ensure directories exist
      initContainers:
        - name: init-dirs
          image: gcr.io/google-containers/busybox:1.27
          command: ['sh', '-c', 'mkdir -p /app/quizzes /app/results /app/uploads && chown -R 1001:1001 /app/quizzes /app/results /app/uploads && chmod -R 755 /app/quizzes /app/results /app/uploads']
          volumeMounts:
            - name: quizzes
              mountPath: /app/quizzes
            - name: results
              mountPath: /app/results
            - name: uploads
              mountPath: /app/uploads

      containers:
        - name: quizmaster-pro
          image: ghcr.io/sapetor/quizmaster-pro:latest
          # Use IfNotPresent to avoid Docker Hub rate limits
          # Change to Always only when debugging image issues
          imagePullPolicy: IfNotPresent

          envFrom:
            - configMapRef:
                name: quizmaster-config

          ports:
            - containerPort: 3000

          # Resource requests/limits - prevents BestEffort QoS (first to evict)
          # Higher ephemeral-storage request = evicted later during disk pressure
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
              ephemeral-storage: "256Mi"
            limits:
              memory: "512Mi"
              cpu: "500m"
              ephemeral-storage: "1Gi"

          # Liveness probe - restart if unhealthy
          livenessProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3

          # Readiness probe - don't send traffic until ready
          readinessProbe:
            httpGet:
              path: /ready
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

          volumeMounts:
            - name: quizzes
              mountPath: /app/quizzes
            - name: results
              mountPath: /app/results
            - name: uploads
              mountPath: /app/public/uploads

      volumes:
        - name: quizzes
          persistentVolumeClaim:
            claimName: quizmaster-quizzes
        - name: results
          persistentVolumeClaim:
            claimName: quizmaster-results
        - name: uploads
          persistentVolumeClaim:
            claimName: quizmaster-uploads
---
# PodDisruptionBudget - protects against voluntary evictions (node drain, upgrades)
# Note: Does NOT protect against disk pressure evictions (those are involuntary)
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: quizmaster-pdb
  namespace: quizmaster
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: quizmaster-pro
