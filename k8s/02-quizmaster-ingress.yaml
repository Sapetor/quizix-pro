# Standalone Ingress for QuizMaster Pro
# Uses path-based routing matching cluster's namespace isolation policy
# Path must match namespace name: /quizmaster for quizmaster namespace
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: quizmaster-ingress
  namespace: quizmaster
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # Increased timeout for Socket.IO WebSocket connections
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    # Critical for Socket.IO - enables WebSocket support
    nginx.ingress.kubernetes.io/websocket-services: "quizmaster-pro"
    # Session affinity for Socket.IO sticky sessions
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "quizmaster-affinity"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "10800"
    # Enable regex matching for path capture
    nginx.ingress.kubernetes.io/use-regex: "true"
    # Rewrite /quizmaster/xyz to /xyz preserving the path
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    # Disable NGINX proxy buffering to ensure fresh content delivery
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          # Access at: http://your-cluster-ip/quizmaster
          # Regex pattern captures path after /quizmaster for rewrite
          # /quizmaster/api/ping -> /api/ping, /quizmaster -> /
          - path: /quizmaster(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: quizmaster-pro
                port:
                  number: 3000

---
# Option 2: Integrate into your existing lab-apps ingress
# INSTRUCTIONS:
# If you prefer to use a single ingress for all apps, add this path to your existing
# k8s/ingress.yaml file in the 'lab' namespace:
#
# In your existing ingress.yaml, add this path under spec.rules[0].http.paths:
#
#   - path: /quiz
#     pathType: Prefix
#     backend:
#       service:
#         name: quizmaster-pro
#         port:
#           number: 3000
#
# Then update the annotations in your lab-apps ingress to include:
#
#   annotations:
#     nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"  # Change from 60 to 3600
#     nginx.ingress.kubernetes.io/websocket-services: "quizmaster-pro"
#     nginx.ingress.kubernetes.io/affinity: "cookie"
#     nginx.ingress.kubernetes.io/session-cookie-name: "quizmaster-affinity"
#
# IMPORTANT: QuizMaster Pro service must be in the same namespace as your ingress.
# If you want to use the 'lab' namespace instead of 'quizmaster', change the namespace
# in 01-quizmaster-pro.yaml from 'quizmaster' to 'lab'

---
# Option 3: Cross-namespace service reference (if keeping separate namespaces)
# If you want to keep QuizMaster in 'quizmaster' namespace but access from 'lab' ingress:
#
# Create an ExternalName service in 'lab' namespace that points to 'quizmaster':
#
# apiVersion: v1
# kind: Service
# metadata:
#   name: quizmaster-proxy
#   namespace: lab
# spec:
#   type: ExternalName
#   externalName: quizmaster-pro.quizmaster.svc.cluster.local
#   ports:
#     - port: 3000
#
# Then in your lab-apps ingress, reference:
#   backend:
#     service:
#       name: quizmaster-proxy
#       port:
#         number: 3000
